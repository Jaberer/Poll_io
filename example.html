<html lang="en">
<head>
    <title>
        Poll.io
    </title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="description" content="Poll for cool info from all your friends and peers with poll.io!">

    <link rel="stylesheet" href="stylesheets/d3.css">
    <link rel="stylesheet" href="stylesheets/example.css">
    <link rel="stylesheet" href="stylesheets/normalize.css">
    <link href='https://fonts.googleapis.com/css?family=Ubuntu:300' rel='stylesheet' type='text/css'>
    <link rel="icon" type="image/png" href="assets/favicon.png">

    <script src="//www.parsecdn.com/js/parse-1.6.2.min.js"></script>
    <script src='http://d3js.org/d3.v3.min.js'></script>
    <script src='http://labratrevenge.com/d3-tip/javascripts/d3.tip.v0.6.3.js'></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
</head>

<body>
    <div id="wrapper" class="home">
        <header>
            <div class="container">
                <nav class="navbar" role="navigation">
                    <div class="navbar-header">
                        <a href="#" class="logo">
                            <img src="" alt="">
                        </a>
                    </div>
                    <!-- Collect the nav links, forms, and other content for toggling -->
                    <div class="collapse navbar-collapse" id="header-nav">
                    </div><!-- /.navbar-collapse -->
                </nav>
            </div><!-- /.container-fluid -->
        </header>
        <div class="home-page">
        <div class="container">
            <div class="row">
                <div class="col-md-6 home-image visible-xs">
                </div>
                <div class="col-md-6">
                    <div class="row">
                        <div class="col-md-12">
                            <div class="home-slogan">
                                Why is the sky blue?
                                <br>Why is Donald Trump...Donald Trump?
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <button type="submit" class="invisible community btn btn-default off">Community 1</button>
                        <button type="submit" class="invisible community btn btn-default off">Community 2</button>
                        <button type="submit" class="invisible community btn btn-default off">Community 3</button>
                        <button type="submit" class="invisible community btn btn-default off">Community 4</button>
                        <div class="col-xs-12">
                            <div class="row">
                                <form class="form home-form" role="form">
                                    <div class="col-md-7">
                                        <div class="form-group">
                                            <input type="text"
                                                   maxlength="50"
                                                   class="form-control"
                                                   placeholder="ie. Who will win the next election?"
                                                   onsubmit=" event.preventDefault(); postQuestion()">
                                        </div>
                                    </div>
                                    <div class="col-md-3">
                                        <div class="form-group">
                                            <button type="submit"
                                                    class="btn btn-default"
                                                    onsubmit=" event.preventDefault(); postQuestion() return false">Submit</button>
                                        </div>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<script>
    var EXAMPLE_QUESTION = 'ie. Who will win the next election?';
    var EXAMPLE_PHONE = '+14256287248';

    console.log('initialize here');
    Parse.initialize("h9oTr2VclhlSeGPwLjm3VWGS5TmeXLnUmdXfwXpK", "E6EhFQPwTQmU3Js7p4aalq080sKkS5UqT7vUrgJZ");

    console.log('done initializing, starting polling');



    var currentUser = Parse.User.current();
    console.log('hello!');
        console.log('logging in...');
        // really brute force automated login process
        Parse.User.logIn("calvin", "password", {
            success: function(user) {
                // Do stuff after successful login.
                console.log('successful login: ' + user);
                var currentUser = Parse.User.current();
                var Channel = Parse.Object.extend('Channel');
                var channelQuery = new Parse.Query(Channel);
                channelQuery.find({
                    success: function(results){
                        if(results.length == 0){
                            // bad results
                            console.log('no channels found!');
                        }
                        else{
                            console.log('found results!');
                            console.log($('input').val());

                            var Poll = Parse.Object.extend('Poll');
                            var poll = new Poll();

                            poll.set('open', true);
                            poll.set('submitter', currentUser);
                            poll.set('topic', 'asdf');
                            poll.set('channel', results[0]);

                            poll.save(null, {
                                success: function(newPoll) {
                                    console.log('new poll saved!');
                                    return false;
                                },
                                error: function(newPoll, error) {
                                    console.log('new poll NOT saved');
                                    return false;
                                }
                            });
                        }
                    },
                    error: function(error){
                        console.log('error in finding channels!');
                        return false;
                    }
                });
            },
            error: function(user, error) {
                console.log('failed login: ' + error);
                // The login failed. Check error to see why.
                Parse.User.logIn("aneesh", "password", {
                    success: function(user) {
                        // Do stuff after successful login.
                        console.log('successful login: ' + user);
                    },
                    error: function(user, error) {
                        console.log('failed login: ' + error);
                        // The login failed. Check error to see why.
                        Parse.User.logIn("joseph", "password", {
                            success: function(user) {
                                // Do stuff after successful login.
                                console.log('successful login: ' + user);
                            },
                            error: function(user, error) {
                                console.log('failed login: ' + error);
                                // The login failed. Check error to see why.

                            }
                        });
                    }
                });
            }
        });


//
//    // create new user when asking for phone number
//    var user = new Parse.User();
//    user.set("username", '+1' + EXAMPLE_PHONE);
//    user.set("password", '+1' + EXAMPLE_PHONE);
//    user.set("phonenumber", '+1' + EXAMPLE_PHONE);
//
//    user.signUp(null, {
//        success: function(user) {
//            // change signup box to question box!
//            $('input').val('');
//            $('input').attr('maxlength', 140);
//            $('input').attr('placeholder', EXAMPLE_QUESTION);
//            $('input').focus();
//        },
//        error: function(user, error) {
//            // Show the error message somewhere and let the user try again.
//            alert('Oops, something went wrong. Try again?');
//            $('input').focus();
//        }
//    });

    var channelsAvailable;


    function postQuestion(){
        // already logged in - handle poll posting!
//        if(currentUser != null){
        var Channel = Parse.Object.extend('Channel');
        var channelQuery = new Parse.Query(Channel);
        channelQuery.find({
            success: function(results){
                if(results.length == 0){
                    // bad results
                    console.log('no channels found!');
                }
                else{
                    console.log('found results!');
                    console.log($('input').val());

                    var Poll = Parse.Object.extend('Poll');
                    var poll = new Poll();

                    poll.set('open', true);
                    poll.set('submitter', currentUser);
                    poll.set('topic', '');
                    poll.set('channel', channelsAvailable[0]);

                    poll.save().save(null, {
                        success: function(newPoll) {
                            console.log('new poll saved!');
                            return false;
                        },
                        error: function(newPoll, error) {
                            console.log('new poll NOT saved');
                            return false;
                        }
                    });
                }
            },
            error: function(error){
                console.log('error in finding channels!');
                return false;
            }
        });

//        }

        // first time logging in - produce communities to join
        // TODO: make input and button invisible with animate.css
        // TODO: make communities appear with animate.css

//        console.log('hello!');
//        // create new user when asking for phone number
//        var user = new Parse.User();
//        user.set("username", '+1' + $('input').value);
//        user.set("password", '+1' + $('input').value);
//        user.set("phonenumber", '+1' + $('input').value);
//
//        user.signUp(null, {
//        success: function(user) {
//            // change signup box to question box!
//            $('input').val('');
//            $('input').attr('maxlength', 140);
//            $('input').attr('placeholder', EXAMPLE_QUESTION);
//            $('input').focus();
//            },
//            error: function(user, error) {
//                // Show the error message somewhere and let the user try again.
//                alert('Oops, something went wrong. Try again?');
//                $('input').focus();
//            }
//        });
    }



    function toggle(button)
    {
        if(document.getElementById("1").value=="OFF"){
            document.getElementById("1").value="ON";}

        else if(document.getElementById("1").value=="ON"){
            document.getElementById("1").value="OFF";}
    }
</script>

<div class="d3-body">

</div>

    </body>

<link type='text/css' src="https://raw.githubusercontent.com/daneden/animate.css/master/animate.min.css">
<link type='text/css' src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">
<script>
    var margin = {top: 85, right: 40, bottom: 25, left: 40},
            width = Math.max(document.documentElement.clientWidth, window.innerWidth || 0)
                    - margin.left - margin.right,
            height = Math.max(document.documentElement.clientHeight, window.innerHeight || 0)
                    - margin.top - margin.bottom;

    var tip = d3.tip()
            .attr('class', 'd3-tip')
            .offset([-10, 0])
            .html(function(d) {
                var cache = [];
                return '<strong>Data:</strong> <span style="color:#E9F2F9">'
// interesting work around for any circular JSONs
//                    + JSON.stringify(d,
//                        function(key, score) {
//                            if (typeof score === 'object' && score !== null) {
//                                if (cache.indexOf(score) !== -1) {
//                                    // Circular reference found, discard key
//                                    return;
//                                }
//                                // Store score in our collection
//                                cache.push(score);
//                            }
//                            return score;
//                        });
//                cache = [];
                        + ' count: ' + d.count + ' score: ' + d.score
                        + '</span>';
            });
    var zoom = d3.behavior.zoom();
    var active = d3.select(null);
    var svg = d3.select('body').append('svg')
            .attr('width', width + margin.left + margin.right)
            .attr('height', height + margin.top + margin.bottom)
            .append('g')
//        .call(zoom.on("zoom", redraw))
            .attr('transform', 'translate(' + margin.left + ',' + margin.top + ')');
    var JsonData;


    function redraw() {
        var translation = d3.event.translate,
                newx = translation[0],
                newy = translation[1];
        console.log("translate: ", zoom.translate(), "scale:", zoom.scale());
        svg.attr("transform",
                "translate(" + newx + "," + newy + ")"
                + " scale(" + zoom.scale() + ")");
    }

    function manualZoom(){
        var translation = zoom.translate,
                newx = translation[0],
                newy = translation[1];
        svg.attr("transform",
                "translate(" + newx + "," + newy + ")"
                + " scale(" + zoom.scale() + ")");
    }

    // tip hovering
    svg.call(tip);

    // x-axis
    var xScale = d3.scale.linear()
            .domain([-100, 100]) // these are value mappings
            .range([0, width]); // these are pixels
    // y-axis
    var yScale;

    d3.json('data.json', function(error, data){
        if(error){
            console.err('data.json Error: ' + error);
            return;
        }
        JsonData = data;
        var xAxis = d3.svg.axis()
                .scale(xScale)
                .orient('bottom');

        yScale = d3.scale.linear()
                .domain([0, d3.max(data, function(d) { return d.count; })])
                .range([height, 0]);

        //Define Y axis
        var yAxis = d3.svg.axis()
                .scale(yScale)
                .orient('left');

        // X Axis drawing
        svg.append('g')
                .attr('class', 'x axis')
                .attr('transform', 'translate(0,' + height + ')')
                .attr('y', 6)
                .attr('dy', '.71em')
                .style('text-anchor', 'end')
                .text('Score')
                .call(xAxis);

        // Y Axis drawing
        svg.append('g')
                .attr('class', 'y axis')
                .call(yAxis)
                .append('text')
                .attr('transform', 'rotate(-90)')
                .attr('y', 6)
                .attr('dy', '.71em')
                .style('text-anchor', 'end')
                .text('Count');

        // Data Bar
        svg.selectAll('.bar')
                .data(data)
                .enter().append('rect')
                .attr('class', 'bar')
                .attr('class', function(d) {
                    if(d.score < -15){
                        return 'bar negative';
                    }
                    else if(d.score < 15){
                        return 'bar neutral';
                    }
                    else {
                        return 'bar positive';
                    }
                })
                .attr('x', function(d) { return xScale(d.score) - 8; })
                .attr('width', 16)
                .attr('y', function(d) { return yScale(d.count); })
                .attr('height', function(d) { return height - yScale(d.count); })
                .on('mouseover', tip.show)
                .on('mouseout', tip.hide);
    });

    // constant colors for dark gray and selected turquoise
    var DARK_GRAY = '#45484B';
    var SELECTED_COLOR = '#30dbbd';
    var SELECTED_RGB = 'rgb(48, 219, 189)';
    var DARK_RGB = 'rgb(69, 72, 75)';

    // dynamic function to handle bar clicks
    $(document).on('click', '.bar', function () {
        if($(this).css('fill') == SELECTED_RGB){
            // show selected
            $(this).css('fill', '');

            // reset darkened bars
            $('.bar').filter(function() {
                return ( $(this).css('fill') == DARK_RGB );
            }).attr('style', '');
            $('svg').attr('style', '');
            return;
        }

        // all become dark gray
        $('.bar').filter(function() {
            return ( $(this).css('fill') != SELECTED_COLOR );
        }).css('fill', DARK_GRAY); // change background color of all black spans
//        $('svg').css('background-color', 'white');
        // selected bar becomes selected color
        $(this).css('fill', SELECTED_COLOR);
    });
</script>
</html>